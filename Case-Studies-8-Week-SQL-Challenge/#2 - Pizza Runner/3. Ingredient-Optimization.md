## Case Study Questions - Ingredient Optimisation

1. What are the standard ingredients for each pizza?

2. What was the most commonly added extra?

3. What was the most common exclusion?

4. Generate an order item for each record in the `customers_orders` table in the format of one of the following:

   - `Meat Lovers`

   - `Meat Lovers - Exclude Beef`
   - `Meat Lovers - Extra Bacon`
   - `Meat Lovers - Exclude Cheese, Bacon - Extra Mushroom, Peppers`

5. Generate an alphabetically ordered comma separated ingredient list for each pizza order from the `customer_orders` table and add a 2x in front of any relevant ingredients.

   For example: `"Meat Lovers: 2xBacon, Beef, ... , Salami"`

6. What is the total quantity of each ingredient used in all delivered pizzas sorted by most frequent first?

<br>

---

## Solutions:

---

### 1. What are the standard ingredients for each pizza?

```sql
WITH 

exploded_toppings AS (SELECT pizza_id, CAST(UNNEST(string_to_array(toppings, ',')) AS INTEGER) AS topping_id
		      FROM pizza_recipes),

recipes AS (SELECT et.pizza_id, et.topping_id, pt.topping_name
	    FROM exploded_toppings et
	    LEFT JOIN pizza_toppings pt
	    ON et.topping_id = pt.topping_id)

SELECT    r.pizza_id, pizza_name, topping_id, topping_name
FROM 	  recipes r
LEFT JOIN pizza_names pn
ON r.pizza_id = pn.pizza_id
```

**Explanation:**

This query transforms a denormalized toppings list into a clear, structured output by:

Exploding the comma-separated topping IDs for each pizza

Mapping each topping ID to its name

Joining with pizza names to make the output human-readable

This enables stakeholders to:

Quickly understand each pizzaâ€™s composition

Identify common ingredients across pizzas

Support menu decisions, inventory planning, and marketing content creation

#### Result set:

| pizza_id | pizza_name | topping_id | topping_name |
| -------- | ---------- | ---------- | ------------ |
| 1        | Meatlovers | 2          | BBQ Sauce    |
| 1        | Meatlovers | 8          | Pepperoni    |
| 1        | Meatlovers | 4          | Cheese       |
| 1        | Meatlovers | 10         | Salami       |
| 1        | Meatlovers | 5          | Chicken      |
| 1        | Meatlovers | 1          | Bacon        |
| 1        | Meatlovers | 6          | Mushrooms    |
| 1        | Meatlovers | 3          | Beef         |
| 2        | Vegetarian | 12         | Tomato Sauce |
| 2        | Vegetarian | 4          | Cheese       |
| 2        | Vegetarian | 6          | Mushrooms    |
| 2        | Vegetarian | 7          | Onions       |
| 2        | Vegetarian | 9          | Peppers      |
| 2        | Vegetarian | 11         | Tomatoes     |

---

### 2. What was the most commonly added extra?

```sql
WITH top_topping AS 

(SELECT CAST(UNNEST(string_to_array(extras, ',')) AS INTEGER) AS extras_id, COUNT(*) AS frequency
FROM temp_customer_orders c
GROUP BY extras_id
ORDER BY frequency DESC 
LIMIT 1)

SELECT 	   topping_name, frequency
FROM 	   top_topping tt
INNER JOIN pizza_toppings pt
ON 	   tt.extras_id = pt.topping_id
```

#### Result set:

| topping_name | frequency |
| ------------ | --------- |
| Bacon        | 4         |

---

### 3. What was the most common exclusion?

```sql
WITH exclusion_freq AS

(SELECT CAST(UNNEST(string_to_array(exclusions, ',')) AS INTEGER) AS exclusion_id, COUNT(*) AS frequency
FROM temp_customer_orders
GROUP BY exclusion_id)

SELECT topping_name, frequency
FROM exclusion_freq ef
INNER JOIN pizza_toppings pt
ON ef.exclusion_id = pt.topping_id
ORDER BY frequency DESC
LIMIT 1;
```

#### Result set:

| topping_name | frequency |
| ------------ | --------- |
| Cheese       | 4         |

---

### 4. Generate an order item for each record in the `customers_orders` table in the format of one of the following:

- `Meat Lovers`

- `Meat Lovers - Exclude Beef`
- `Meat Lovers - Extra Bacon`
- `Meat Lovers - Exclude Cheese, Bacon - Extra Mushroom, Peppers`

```sql
WITH

exploded_exclusions AS (SELECT order_id,
		               CAST(UNNEST(string_to_array(exclusions, ',')) AS INTEGER) AS exclusion_id
		        FROM temp_customer_orders
			WHERE exclusions IS NOT NULL),

exclusion_names AS (SELECT e.order_id, STRING_AGG(topping_name, ', ') AS exclusions
				FROM exploded_exclusions e
				INNER JOIN pizza_toppings pt ON
				e.exclusion_id = pt.topping_id
				GROUP BY order_id),

exploded_extras AS (SELECT order_id,
		           CAST(UNNEST(string_to_array(extras, ',')) AS INTEGER) AS extra_id
		    FROM temp_customer_orders),

extra_names AS (SELECT order_id,
			STRING_AGG(topping_name, ', ') AS toppings
		FROM exploded_extras ee
		INNER JOIN pizza_toppings pt
		ON ee.extra_id = pt.topping_id
		GROUP BY ee.order_id)

SELECT co.order_id, co.customer_id, pn.pizza_name ||
	   CASE WHEN co.extras IS NOT NULL THEN ' - Extra ' || en.toppings ELSE '' END ||
	   CASE WHEN co.exclusions IS NOT NULL THEN ' - Exclude ' || exn.exclusions ELSE '' END
FROM temp_customer_orders co
LEFT JOIN pizza_names pn ON co.pizza_id = pn.pizza_id
LEFT JOIN extra_names en ON co.order_id = en.order_id
LEFT JOIN exclusion_names exn ON co.order_id = exn.order_id
ORDER BY order_id, customer_id;
```

#### Result set:

| order_id | customer_id | order_description                                               |
| -------- | ----------- | --------------------------------------------------------------- |
| 1        | 101         | Meatlovers                                                      |
| 2        | 101         | Meatlovers                                                      |
| 3        | 102         | Vegetarian                                                      |
| 3        | 102         | Meatlovers                                                      |
| 4        | 103         | Meatlovers - Exclude Cheese, Cheese, Cheese                     |
| 4        | 103         | Meatlovers - Exclude Cheese, Cheese, Cheese                     |
| 4        | 103         | Vegetarian - Exclude Cheese, Cheese, Cheese                     |
| 5        | 104         | Meatlovers - Extra Bacon                                        |
| 6        | 101         | Vegetarian                                                      |
| 7        | 105         | Vegetarian - Extra Bacon                                        |
| 8        | 102         | Meatlovers                                                      |
| 9        | 103         | Meatlovers - Exclude Cheese - Extra Bacon, Chicken              |
| 10       | 104         | Meatlovers        						   |
| 10       | 104         | Meatlovers - Exclude BBQ Sauce, Mushrooms - Extra Bacon, Cheese |

### Pizza Order Summary Generator

This SQL query cleans and transforms raw pizza order data by:

- Parsing string-based `exclusions` and `extras`
- Mapping topping IDs to their names
- Dynamically generating readable, customer-friendly order descriptions

#### Business Context

This logic supports:

- Customer-facing receipts and order confirmations  
- Loyalty program tracking  
- Analysis of product customization trends for marketing and menu optimization

---

### 5. Generate an alphabetically ordered comma separated ingredient list for each pizza order from the `customer_orders` table and add a 2x in front of any relevant ingredients.

For example: `"Meat Lovers: 2xBacon, Beef, ... , Salami"`

```sql
WITH exploded_toppings AS (SELECT co.order_id, co.pizza_id, co.extras,
				  CAST(topping_id AS INTEGER) AS toppings
			   FROM temp_customer_orders co
			   LEFT JOIN pizza_recipes pr ON co.pizza_id = pr.pizza_id
			   CROSS JOIN LATERAL UNNEST(string_to_array(pr.toppings, ',')) AS r(topping_id)),

-- attach topping names and mark extras as '2x' when present in extras list
ingredient_details AS (SELECT et.order_id, et.pizza_id, 
			      CASE WHEN et.toppings = ANY(string_to_array(et.extras, ',')::INTEGER[])
			   	   THEN '2x ' || pt.topping_name ELSE pt.topping_name END AS ingredient_with_extra
			FROM exploded_toppings et
			LEFT JOIN pizza_toppings pt
			ON et.toppings = pt.topping_id
			ORDER BY order_id),

-- group toppings into a single comma-separated list for each order
aggregated_ingredients AS (SELECT order_id, pizza_id,
				  STRING_AGG(DISTINCT ingredient_with_extra, ', ' ORDER BY ingredient_with_extra) AS ingredients
			   FROM ingredient_details 
			   GROUP BY order_id, pizza_id)

-- combine pizza name with topping list to build final order description
SELECT ai.order_id, 
       CONCAT(pn.pizza_name, ': ', ai.ingredients) AS order_description
FROM aggregated_ingredients ai
LEFT JOIN pizza_names pn
ON ai.pizza_id = pn.pizza_id
ORDER BY ai.order_id
```

**Explanation:**

- **Ingredients CTE**:

  - This part generates a list of all ingredients for each pizza, marking those that are also listed as extras with "2x".

  - The `CROSS JOIN LATERAL` with `unnest` is used to expand the toppings listed in `pizza_recipes` into individual rows, which are then joined with `pizza_toppings` to get the topping names.

  - Ingredients that are extras have "2x" prefixed directly.

- **AggregatedIngredients CTE**:

  - Aggregates the ingredients (including "2x" prefixed extras) for each order into a single, alphabetically ordered string.

  - `DISTINCT` inside `STRING_AGG` ensures no duplicate ingredient listings, addressing cases where an ingredient might be listed both as a base ingredient and an extra.

- **Final SELECT**: Constructs the final output by combining the pizza name with the aggregated ingredient list, ordered by `order_id`.

#### Result set:

| order_id | order_description                                                                                    |
| -------- | ---------------------------------------------------------------------------------------------------- |
| 1        | Meatlovers: BBQ Sauce, Bacon, Beef, Cheese, Chicken, Mushrooms, Pepperoni, Salami                    |
| 2        | Meatlovers: BBQ Sauce, Bacon, Beef, Cheese, Chicken, Mushrooms, Pepperoni, Salami                    |
| 3        | Meatlovers: BBQ Sauce, Bacon, Beef, Cheese, Chicken, Mushrooms, Pepperoni, Salami                    |
| 3        | Vegetarian: Cheese, Mushrooms, Onions, Peppers, Tomato Sauce, Tomatoes                               |
| 4        | Meatlovers: BBQ Sauce, Bacon, Beef, Cheese, Chicken, Mushrooms, Pepperoni, Salami                    |
| 4        | Vegetarian: Cheese, Mushrooms, Onions, Peppers, Tomato Sauce, Tomatoes                               |
| 5        | Meatlovers: 2xBacon, BBQ Sauce, Beef, Cheese, Chicken, Mushrooms, Pepperoni, Salami                  |
| 6        | Vegetarian: Cheese, Mushrooms, Onions, Peppers, Tomato Sauce, Tomatoes                               |
| 7        | Vegetarian: Cheese, Mushrooms, Onions, Peppers, Tomato Sauce, Tomatoes                               |
| 8        | Meatlovers: BBQ Sauce, Bacon, Beef, Cheese, Chicken, Mushrooms, Pepperoni, Salami                    |
| 9        | Meatlovers: 2xBacon, 2xChicken, BBQ Sauce, Beef, Cheese, Mushrooms, Pepperoni, Salami                |
| 10       | Meatlovers: 2xBacon, 2xCheese, BBQ Sauce, Bacon, Beef, Cheese, Chicken, Mushrooms, Pepperoni, Salami |

---

### 6. What is the total quantity of each ingredient used in all delivered pizzas sorted by most frequent first?

```sql
WITH num_pizza_ordered AS (SELECT pizza_id, COUNT(*) AS num_ordered 
							FROM temp_customer_orders
							GROUP BY pizza_id),

exploded_toppings AS (SELECT pizza_id, CAST(UNNEST(string_to_array(toppings, ','))AS INTEGER) AS toppings, COUNT(*) as t_count
						FROM pizza_recipes
						GROUP BY pizza_id, toppings),

base_top_count AS (SELECT toppings, CAST(SUM(t_count * num_ordered) AS INTEGER) AS top_count
						FROM exploded_toppings et
						INNER JOIN num_pizza_ordered po ON et.pizza_id = po.pizza_id
						GROUP BY toppings),

extras_count AS (SELECT CAST(UNNEST(STRING_TO_ARRAY(extras, ',')) AS INTEGER) as extras_id, COUNT(*) as num_extras
					FROM temp_customer_orders
					GROUP BY 1),

exclusions_count AS (SELECT CAST(UNNEST(STRING_TO_ARRAY(exclusions, ',')) AS INTEGER) as exclusion_id, COUNT(*) as num_exclusions
					FROM temp_customer_orders
					GROUP BY 1)

SELECT pt.topping_name, top_count + COALESCE(num_extras, 0) + COALESCE(num_exclusions, 0) * -1 AS total_use
FROM base_top_count btc
LEFT JOIN extras_count ec ON btc.toppings = ec.extras_id
LEFT JOIN exclusions_count ec1 ON btc.toppings = ec1.exclusion_id
LEFT JOIN pizza_toppings pt ON btc.toppings = pt.topping_id
ORDER BY total_use DESC
```

#### Result set:

| Rank | Topping Name    | Total Use |
|------|------------------|------------|
| 1    | Bacon            | 14         |
| 2    | Mushrooms        | 13         |
| 3    | Chicken          | 11         |
| 4    | Cheese           | 11         |
| 5    | Pepperoni        | 10         |
| 6    | Salami           | 10         |
| 7    | Beef             | 10         |
| 8    | BBQ Sauce        | 9          |
| 9    | Tomato Sauce     | 4          |
| 10   | Onions           | 4          |
| 11   | Peppers          | 4          |
| 12   | Tomatoes         | 4          |

**Business Insight**

This queries tell us which toppings are most used across all pizzas

Combines base recipes + customer behavior

Helps with:

Inventory decisions (buy more of popular toppings)

Menu redesign (consider removing unused toppings)

Customer preference analysis (which toppings are frequently doubled)

---
